##  æ¦‚è§ˆ ##

æœ¬æ–‡çš„é‡ç‚¹ä¼šæ”¾åœ¨`req`è¿™ä¸ªå¯¹è±¡ä¸Šã€‚å‰é¢å·²ç»æåˆ°ï¼Œå®ƒå…¶å®æ˜¯http.IncomingMessageå®ä¾‹ï¼Œåœ¨æœåŠ¡ç«¯ã€å®¢æˆ·ç«¯ä½œç”¨ç•¥å¾®æœ‰å·®å¼‚

 *  æœåŠ¡ç«¯å¤„ï¼šè·å–è¯·æ±‚æ–¹çš„ç›¸å…³ä¿¡æ¯ï¼Œå¦‚request headerç­‰ã€‚
 *  å®¢æˆ·ç«¯å¤„ï¼šè·å–å“åº”æ–¹è¿”å›çš„ç›¸å…³ä¿¡æ¯ï¼Œå¦‚statusCodeç­‰ã€‚

æœåŠ¡ç«¯ä¾‹å­ï¼š

    // ä¸‹é¢çš„ req
    var http = require('http');
    var server = http.createServer(function(req, res){
        console.log(req.headers);
        res.end('ok');
    });
    server.listen(3000);

å®¢æˆ·ç«¯ä¾‹å­

    // ä¸‹é¢çš„res
    var http = require('http');
    http.get('http://127.0.0.1:3000', function(res){
        console.log(res.statusCode);
    });

##  å±æ€§/æ–¹æ³•/äº‹ä»¶ åˆ†ç±» ##

http.IncomingMessageçš„å±æ€§/æ–¹æ³•/äº‹ä»¶ ä¸æ˜¯ç‰¹åˆ«å¤šï¼ŒæŒ‰ç…§æ˜¯å¦å®¢æˆ·ç«¯/æœåŠ¡ç«¯ ç‰¹æœ‰çš„ï¼Œä¸‹é¢è¿›è¡Œç®€å•å½’ç±»ã€‚å¯ä»¥çœ‹åˆ°

 *  æœåŠ¡ç«¯å¤„ç‰¹æœ‰ï¼šurl
 *  å®¢æˆ·ç«¯å¤„ç‰¹æœ‰ï¼šstatusCodeã€statusMessage

<table> 
 <thead> 
  <tr> 
   <th style="text-align:left;">ç±»å‹</th> 
   <th style="text-align:center;">åç§°</th> 
   <th style="text-align:center;">æœåŠ¡ç«¯</th> 
   <th style="text-align:center;">å®¢æˆ·ç«¯</th> 
  </tr> 
 </thead> 
 <tbody> 
  <tr> 
   <td style="text-align:left;">äº‹ä»¶</td> 
   <td style="text-align:center;">aborted</td> 
   <td style="text-align:center;">âœ“</td> 
   <td style="text-align:center;">âœ“</td> 
  </tr> 
  <tr> 
   <td style="text-align:left;">äº‹ä»¶</td> 
   <td style="text-align:center;">close</td> 
   <td style="text-align:center;">âœ“</td> 
   <td style="text-align:center;">âœ“</td> 
  </tr> 
  <tr> 
   <td style="text-align:left;">å±æ€§</td> 
   <td style="text-align:center;">headers</td> 
   <td style="text-align:center;">âœ“</td> 
   <td style="text-align:center;">âœ“</td> 
  </tr> 
  <tr> 
   <td style="text-align:left;">å±æ€§</td> 
   <td style="text-align:center;">rawHeaders</td> 
   <td style="text-align:center;">âœ“</td> 
   <td style="text-align:center;">âœ“</td> 
  </tr> 
  <tr> 
   <td style="text-align:left;">å±æ€§</td> 
   <td style="text-align:center;">statusCode</td> 
   <td style="text-align:center;">âœ•</td> 
   <td style="text-align:center;">âœ“</td> 
  </tr> 
  <tr> 
   <td style="text-align:left;">å±æ€§</td> 
   <td style="text-align:center;">statusMessage</td> 
   <td style="text-align:center;">âœ•</td> 
   <td style="text-align:center;">âœ“</td> 
  </tr> 
  <tr> 
   <td style="text-align:left;">å±æ€§</td> 
   <td style="text-align:center;">httpVersion</td> 
   <td style="text-align:center;">âœ“</td> 
   <td style="text-align:center;">âœ“</td> 
  </tr> 
  <tr> 
   <td style="text-align:left;">å±æ€§</td> 
   <td style="text-align:center;">url</td> 
   <td style="text-align:center;">âœ“</td> 
   <td style="text-align:center;">âœ•</td> 
  </tr> 
  <tr> 
   <td style="text-align:left;">å±æ€§</td> 
   <td style="text-align:center;">socket</td> 
   <td style="text-align:center;">âœ“</td> 
   <td style="text-align:center;">âœ“</td> 
  </tr> 
  <tr> 
   <td style="text-align:left;">æ–¹æ³•</td> 
   <td style="text-align:center;">.destroy()</td> 
   <td style="text-align:center;">âœ“</td> 
   <td style="text-align:center;">âœ“</td> 
  </tr> 
  <tr> 
   <td style="text-align:left;">æ–¹æ³•</td> 
   <td style="text-align:center;">.setTimeout()</td> 
   <td style="text-align:center;">âœ“</td> 
   <td style="text-align:center;">âœ“</td> 
  </tr> 
 </tbody> 
</table>

##  æœåŠ¡ç«¯çš„ä¾‹å­ ##

###  ä¾‹å­ä¸€ï¼šè·å–httpVersion/method/url ###

ä¸‹é¢æ˜¯ä¸€ä¸ªå…¸å‹çš„HTTPè¯·æ±‚æŠ¥æ–‡ï¼Œé‡Œé¢æœ€é‡è¦çš„å†…å®¹åŒ…æ‹¬ï¼šHTTPç‰ˆæœ¬ã€è¯·æ±‚æ–¹æ³•ã€è¯·æ±‚åœ°å€ã€è¯·æ±‚å¤´éƒ¨ã€‚

    GET /hello HTTP/1.1
    Host: 127.0.0.1:3000
    Connection: keep-alive
    Cache-Control: no-cache

é‚£ä¹ˆï¼Œå¦‚ä½•è·å–ä¸Šé¢æåˆ°çš„ä¿¡æ¯å‘¢ï¼Ÿå¾ˆç®€å•ï¼Œç›´æ¥ä¸Šä»£ç 

    // getClientInfo.js
    var http = require('http');
    
    var server = http.createServer(function(req, res){
        console.log( '1ã€å®¢æˆ·ç«¯è¯·æ±‚urlï¼š' + req.url );
        console.log( '2ã€httpç‰ˆæœ¬ï¼š' + req.httpVersion );
        console.log( '3ã€httpè¯·æ±‚æ–¹æ³•ï¼š' + req.method );
        console.log( '4ã€httpè¯·æ±‚å¤´éƒ¨' + JSON.stringify(req.headers) );
    
        res.end('ok');
    });
    
    server.listen(3000);

æ•ˆæœå¦‚ä¸‹ï¼š

    1ã€å®¢æˆ·ç«¯è¯·æ±‚urlï¼š/hello
    2ã€httpç‰ˆæœ¬ï¼š1.1
    3ã€httpè¯·æ±‚æ–¹æ³•ï¼šGET
    4ã€http headersï¼š{"host":"127.0.0.1:3000","connection":"keep-alive","cache-control":"no-cache","user-agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_4) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/54.0.2840.71 Safari/537.36","postman-token":"1148986a-ddfb-3569-e2c0-585634655fe4","accept":"*/*","accept-encoding":"gzip, deflate, sdch, br","accept-language":"zh-CN,zh;q=0.8,en;q=0.6,zh-TW;q=0.4"}

###  ä¾‹å­äºŒï¼šè·å–getè¯·æ±‚å‚æ•° ###

æœåŠ¡ç«¯ä»£ç å¦‚ä¸‹ï¼š

    // getClientGetQuery.js
    var http = require('http');
    var url = require('url');
    var querystring = require('querystring');
    
    var server = http.createServer(function(req, res){
        var urlObj = url.parse(req.url);
        var query = urlObj.query;
        var queryObj = querystring.parse(query);
        
        console.log( JSON.stringify(queryObj) );
        
        res.end('ok');
    });
    
    server.listen(3000);

è®¿é—®åœ°å€ http://127.0.0.1:3000/hello?nick=chyingp&hello=world

æœåŠ¡ç«¯è¾“å‡ºå¦‚ä¸‹

    {"nick":"chyingp","hello":"world"}

###  ä¾‹å­ä¸‰ï¼šè·å–postè¯·æ±‚å‚æ•° ###

æœåŠ¡ç«¯ä»£ç å¦‚ä¸‹

    // getClientPostBody.js
    var http = require('http');
    var url = require('url');
    var querystring = require('querystring');
    
    var server = http.createServer(function(req, res){
        
        var body = '';  
        req.on('data', function(thunk){
            body += thunk;
        });
    
        req.on('end', function(){
            console.log( 'post body is: ' + body );
            res.end('ok');
        }); 
    });
    
    server.listen(3000);

é€šè¿‡curlæ„é€ postè¯·æ±‚ï¼š

    curl -d 'nick=casper&hello=world' http://127.0.0.1:3000

æœåŠ¡ç«¯æ‰“å°å¦‚ä¸‹ï¼š

    post body is: nick=casper&hello=world

å¤‡æ³¨ï¼špostè¯·æ±‚ä¸­ï¼Œä¸åŒçš„`Content-type`ï¼Œpost bodyæœ‰ä¸å°å·®å¼‚ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥ç ”ç©¶ä¸‹ã€‚

æœ¬ä¾‹ä¸­çš„postè¯·æ±‚ï¼ŒHTTPæŠ¥æ–‡å¤§æ¦‚å¦‚ä¸‹

    POST / HTTP/1.1
    Host: 127.0.0.1:3000
    Content-Type: application/x-www-form-urlencoded
    Cache-Control: no-cache
    
    nick=casper&hello=world

##  å®¢æˆ·ç«¯å¤„ä¾‹å­ ##

###  ä¾‹å­ä¸€ï¼šè·å–httpVersion/statusCode/statusMessage ###

ä»£ç å¦‚ä¸‹ï¼š

    var http = require('http');
    var server = http.createServer(function(req, res){
        res.writeHead(200, {'content-type': 'text/plain'});
        res.end('from server');
    });
    server.listen(3000);
    
    var client = http.get('http://127.0.0.1:3000', function(res){
        console.log('1ã€httpç‰ˆæœ¬ï¼š' + res.httpVersion);
        console.log('2ã€è¿”å›çŠ¶æ€ç ï¼š' + res.statusCode);
        console.log('3ã€è¿”å›çŠ¶æ€æè¿°ä¿¡æ¯ï¼š' + res.statusMessage);
        console.log('4ã€è¿”å›æ­£æ–‡ï¼š');
    
        res.pipe(process.stdout);
    });

æ§åˆ¶å°è¾“å‡ºï¼š

    1ã€httpç‰ˆæœ¬ï¼š1.1
    2ã€è¿”å›çŠ¶æ€ç ï¼š200
    3ã€è¿”å›çŠ¶æ€æè¿°ä¿¡æ¯ï¼šOK
    4ã€è¿”å›æ­£æ–‡ï¼š
    from server

##  äº‹ä»¶å¯¹æ¯”ï¼šabortedã€close ##

å®˜æ–¹æ–‡æ¡£å¯¹è¿™ä¸¤ä¸ªäº‹ä»¶çš„è§£é‡Šæ˜¯ï¼šå½“å®¢æˆ·ç«¯ç»ˆæ­¢è¯·æ±‚æ—¶ï¼Œè§¦å‘abortedäº‹ä»¶ï¼›å½“å®¢æˆ·ç«¯è¿æ¥æ–­å¼€æ—¶ï¼Œè§¦å‘closeäº‹ä»¶ï¼›å®˜æ–¹æ–‡æ¡£ä¼ é€ä»¬ï¼š[åœ°å€][Link 1]

è§£é‡Šå¾—æ¯”è¾ƒå«ç³Šï¼Œä»å®é™…å®éªŒå¯¹æ¯”ä¸Šæ¥çœ‹ï¼Œè·Ÿå®˜æ–¹æ–‡æ¡£æœ‰ä¸å°å‡ºå…¥ã€‚æ­¤å¤–ï¼Œå®¢æˆ·ç«¯å¤„ã€æœåŠ¡ç«¯å¤„çš„è¡¨ç°ä¹Ÿæ˜¯ä¸åŒçš„ã€‚

###  æœåŠ¡ç«¯è¡¨ç° ###

æ ¹æ®å®é™…æµ‹è¯•ç»“æœæ¥çœ‹ï¼Œå½“å®¢æˆ·ç«¯ï¼š

 *  abortè¯·æ±‚æ—¶ï¼ŒæœåŠ¡ç«¯reqçš„abortedã€closeäº‹ä»¶éƒ½ä¼šè§¦å‘ï¼›ï¼ˆè¯¡å¼‚ï¼‰
 *  è¯·æ±‚æ­£å¸¸å®Œæˆæ—¶ï¼ŒæœåŠ¡ç«¯reqçš„closeäº‹ä»¶ä¸ä¼šè§¦å‘ï¼›ï¼ˆä¹Ÿå¾ˆè¯¡å¼‚ï¼‰

ç›´æ¥æ‰’äº†ä¸‹nodejsçš„æºä»£ç ï¼Œå‘ç°çš„ç¡®æ˜¯åŒæ—¶è§¦å‘çš„ï¼Œè§¦å‘åœºæ™¯ï¼šè¯·æ±‚æ­£å¸¸ç»“æŸå‰ï¼Œå®¢æˆ·ç«¯abortè¯·æ±‚ã€‚

æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š

    var http = require('http');
    
    var server = http.createServer(function(req, res){
        
        console.log('1ã€æ”¶åˆ°å®¢æˆ·ç«¯è¯·æ±‚: ' + req.url);
        
        req.on('aborted', function(){
            console.log('2ã€å®¢æˆ·ç«¯è¯·æ±‚aborted');
        });
        
        req.on('close', function(){
            console.log('3ã€å®¢æˆ·ç«¯è¯·æ±‚close');
        });
        
        // res.end('ok'); æ•…æ„ä¸è¿”å›ï¼Œç­‰ç€å®¢æˆ·ç«¯ä¸­æ–­è¯·æ±‚
    });
    
    server.listen(3000, function(){
        var client = http.get('http://127.0.0.1:3000/aborted');
        setTimeout(function(){
            client.abort();  // æ•…æ„å»¶è¿Ÿ100msï¼Œç¡®ä¿è¯·æ±‚å‘å‡º
        }, 100);    
    });
    
    
    // è¾“å‡ºå¦‚ä¸‹
    // 1ã€æ”¶åˆ°å®¢æˆ·ç«¯è¯·æ±‚: /aborted
    // 2ã€å®¢æˆ·ç«¯è¯·æ±‚aborted
    // 3ã€å®¢æˆ·ç«¯è¯·æ±‚close

ä»¥ä¸‹ä»£ç æ¥è‡ªnodejsæºç ï¼ˆ\_http\_server.jsï¼‰

    function abortIncoming() {
        while (incoming.length) {
          var req = incoming.shift();
          req.emit('aborted');
          req.emit('close');
        }
        // abort socket._httpMessage ?
      }

å†æ¥ä¸€æ³¢å¯¹æ¯”ï¼Œ`req.on('close')`å’Œ`req.socket.on('close')`ã€‚

    // reqSocketClose.js
    var http = require('http');
    
    var server = http.createServer(function(req, res){
        
        console.log('server: æ”¶åˆ°å®¢æˆ·ç«¯è¯·æ±‚');
        
        req.on('close', function(){
            console.log('server: req close');
        });
        
        req.socket.on('close', function(){
            console.log('server: req.socket close');
        });    
        
        res.end('ok'); 
    });
    
    server.listen(3000);
    
    var client = http.get('http://127.0.0.1:3000/aborted', function(res){
        console.log('client: æ”¶åˆ°æœåŠ¡ç«¯å“åº”');
    });

è¾“å‡ºå¦‚ä¸‹ï¼Œæ­£å„¿å…«ç»çš„closeäº‹ä»¶è§¦å‘äº†ã€‚

    server: æ”¶åˆ°å®¢æˆ·ç«¯è¯·æ±‚
    server: req.socket close
    client: æ”¶åˆ°æœåŠ¡ç«¯å“åº”

###  å®¢æˆ·ç«¯è¡¨ç° ###

çŒœæµ‹å®¢æˆ·ç«¯çš„abortedã€closeä¹Ÿæ˜¯åœ¨ç±»ä¼¼åœºæ™¯ä¸‹è§¦å‘ï¼Œæµ‹è¯•ä»£ç å¦‚ä¸‹ã€‚å‘ç°ä¸€ä¸ªæ¯”è¾ƒæœ‰æ„æ€çš„æƒ…å†µï¼Œ`res.pipe(process.stdout)` è¿™è¡Œä»£ç æ˜¯å¦æ·»åŠ ï¼Œä¼šå½±å“`close`æ˜¯å¦è§¦å‘ã€‚

 *  æ²¡æœ‰`res.pipe(process.stdout)`ï¼šcloseä¸è§¦å‘ã€‚
 *  æœ‰`res.pipe(process.stdout)`ï¼šcloseè§¦å‘ã€‚

    var http = require('http');
    
    var server = http.createServer(function(req, res){
        
        console.log('1ã€æœåŠ¡ç«¯ï¼šæ”¶åˆ°å®¢æˆ·ç«¯è¯·æ±‚');
        
        res.flushHeaders();
        res.setTimeout(100);    // æ•…æ„ä¸è¿”å›ï¼Œ3000msåè¶…æ—¶
    });
    
    
    server.on('error', function(){});
    
    server.listen(3000, function(){
    
        var client = http.get('http://127.0.0.1:3000/aborted', function(res){
    
            console.log('2ã€å®¢æˆ·ç«¯ï¼šæ”¶åˆ°æœåŠ¡ç«¯å“åº”');
    
            // res.pipe(process.stdout); æ³¨æ„è¿™è¡Œä»£ç 
            
            res.on('aborted', function(){
                console.log('3ã€å®¢æˆ·ç«¯ï¼šabortedè§¦å‘ï¼');
            });
    
            res.on('close', function(){
                console.log('4ã€å®¢æˆ·ç«¯ï¼šcloseè§¦å‘ï¼');
            });     
        });
    });

##  ä¿¡æ¯é‡ç•¥å¤§çš„ .destroy() ##

ç»è¿‡å‰é¢abortedã€closeçš„æ‘§æ®‹ï¼Œæœ¬èƒ½çš„è§‰å¾— .destroy() æ–¹æ³•çš„è¡¨ç°ä¼šæœ‰å¾ˆå¤šæƒŠå–œä¹‹å¤„ã€‚

æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š

    var http = require('http');
    
    var server = http.createServer(function(req, res){
        
        console.log('æœåŠ¡ç«¯ï¼šæ”¶åˆ°å®¢æˆ·ç«¯è¯·æ±‚');
        
        req.destroy(new Error('æµ‹è¯•destroy'));
        
        req.on('error', function(error){
            console.log('æœåŠ¡ç«¯ï¼šreq error: ' + error.message);
        });
        
        req.socket.on('error', function(error){
            console.log('æœåŠ¡ç«¯ï¼šreq socket error: ' + error.message);
        })
    });
    
    server.on('error', function(error){
        console.log('æœåŠ¡ç«¯ï¼šserver error: ' + error.message);
    });
    
    server.listen(3000, function(){
    
        var client = http.get('http://127.0.0.1:3000/aborted', function(res){
            // do nothing
        });
    
        client.on('error', function(error){
            console.log('å®¢æˆ·ç«¯ï¼šclient errorè§¦å‘ï¼' + error.message);
        });
    });

è¾“å‡ºå¦‚ä¸‹ã€‚æ ¹æ® .destroy() è°ƒç”¨çš„æ—¶æœºä¸åŒï¼Œerror è§¦å‘çš„å¯¹è±¡ä¸åŒã€‚ï¼ˆæµ‹è¯•è¿‡ç¨‹æ¯”è¾ƒæ¯ç‡¥ï¼Œæœ‰æ—¶é—´å†æ€»ç»“ä¸€ä¸‹ï¼‰

    æœåŠ¡ç«¯ï¼šæ”¶åˆ°å®¢æˆ·ç«¯è¯·æ±‚
    æœåŠ¡ç«¯ï¼šreq socket error: æµ‹è¯•destroy
    å®¢æˆ·ç«¯ï¼šclient errorè§¦å‘ï¼socket hang up

##  ä¸å¸¸ç”¨å±æ€§ ##

 *  rawHeadersï¼šæœªè§£æå‰çš„request headerã€‚
 *  trailersï¼šåœ¨åˆ†å—ä¼ è¾“ç¼–ç (chunk)ä¸­ç”¨åˆ°ï¼Œè¡¨ç¤ºtraileråçš„headerå¯åˆ†å—ä¼ è¾“ã€‚ï¼ˆæ„Ÿå…´è¶£çš„å¯ä»¥ç ”ç©¶ä¸‹ï¼‰
 *  rawTrailersï¼š

å…³äºtrailerså±æ€§ï¼š

> The request/response trailers object. Only populated at the 'end' event.

##  å†™åœ¨åé¢ ##

ä¸€ä¸ªè²Œä¼¼å¾ˆç®€å•çš„å¯¹è±¡ï¼Œå®é™…æ¯”æƒ³çš„è¦å¤æ‚ä¸€äº›ã€‚åšäº†ä¸å°‘å¯¹æ¯”å®éªŒï¼Œä¹Ÿå‘ç°äº†ä¸€äº›å¥½ç©çš„ä¸œè¥¿ï¼Œæ‰“ç®—æ·±å…¥å­¦ä¹ çš„åŒå­¦å¯ä»¥è‡ªå·±å¤šåŠ¨æ‰‹å°è¯•ä¸€ä¸‹ ğŸ˜ƒ

TODOï¼š

1.  å¯¹closeã€abortedè¿›è¡Œæ›´æ·±å…¥å¯¹æ¯”
2.  å¯¹.destroy()è¿›è¡Œæ›´æ·±å…¥å¯¹æ¯”

##  ç›¸å…³é“¾æ¥ ##

å®˜æ–¹æ–‡æ¡£ï¼š https://nodejs.org/api/http.htmlhttp\_class\_http\_incomingmessage


[Link 1]: https://nodejs.org/api/http.html#http_event_aborted_1